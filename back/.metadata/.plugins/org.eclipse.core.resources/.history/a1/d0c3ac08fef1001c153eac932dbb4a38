package com.baemin.service;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.baemin.common.CreateOrderNumber;
import com.baemin.dao.OrderDAO;
import com.baemin.dto.Cart;
import com.baemin.dto.Order;
import com.baemin.dto.User;
import com.baemin.login.LoginDetails;
import com.google.gson.Gson;

@Service
public class OrderServiceImp implements OrderService {

	@Autowired
	private OrderDAO orderDAO;
	
	@Override
	@Transactional
	public ResponseEntity<?> order(Order order, User userInfo) {
		System.out.println("사용 포인트 : " + order.getUsedPoint());
		
		// 회원 유저
		if(userInfo != null) {
			// 사용한 포인트가 회원 포인트보다 많을때 
			System.out.println("사용 포인트 : " + order.getUsedPoint());
			if(order.getUsedPoint() > userInfo.getPoint()) {
				return new ResponseEntity<>("포인트 사용 에러", HttpStatus.BAD_REQUEST);
			}
			
		}
		order.setOrderNum(CreateOrderNumber.getOrderNumer());
		
		Gson gson = new Gson();
		
		String orderMenuJson = gson.toJson(order.getCartList());
		
		// 로그인 상태에 사용 포인트가 있다면 포인트 감소
		
		// 로그인 상태 시 포인트 적립
		
		Map<String, Object> map = new HashMap<>();
		
		// 로그인 중이면
		if(userInfo != null) {
			map.put("userId", userInfo.getUserId());
			map.put("order", order);
			map.put("orderMenuJson", orderMenuJson);
			
			orderDAO.memberOrder(map);
			
			// 주문목록 가져오기
//			orderDAO.orderList(userId);
			
		} else {
			map.put("userId", order.getGuestId());
			map.put("order", order);
			map.put("orderMenuJson", orderMenuJson);
			
			orderDAO.nonMemberOrder(map);
			
			
			
		}
		
		
		
		
		
		return new ResponseEntity<>(HttpStatus.FOUND);
	}



}
